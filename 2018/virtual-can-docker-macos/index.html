<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><link rel=prev href=https://www.thomasantony.com/2016/training-neural-net-for-sdc/><link rel=next href=https://www.thomasantony.com/2019/2019-10-16-hello-world/><link rel=canonical href=https://www.thomasantony.com/2018/virtual-can-docker-macos/><link rel="shortcut icon" type=image/x-icon href=https://www.thomasantony.com/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=https://www.thomasantony.com/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://www.thomasantony.com/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://www.thomasantony.com/favicon-16x16.png><link rel=manifest href=https://www.thomasantony.com/site.webmanifest><link rel=mask-icon href=https://www.thomasantony.com/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>Using VirtualCAN inside docker on macOS | Thomas Antony</title><meta name=title content="Using VirtualCAN inside docker on macOS | Thomas Antony"><link rel=stylesheet href=https://www.thomasantony.com/font/iconfont.css><link rel=stylesheet href=https://www.thomasantony.com/css/main.min.css><meta name=twitter:card content="summary"><meta name=twitter:title content="Using VirtualCAN inside docker on macOS"><meta name=twitter:description content="At SmartAg, we use Docker to manage the development and runtime environments for our embedded software. For performing full-system…"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Using VirtualCAN inside docker on macOS","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.thomasantony.com\/2018\/virtual-can-docker-macos\/"},"genre":"posts","keywords":"docker, socketcan, CANbus, virtual-can","wordcount":429,"url":"https:\/\/www.thomasantony.com\/2018\/virtual-can-docker-macos\/","datePublished":"2018-02-09T03:42:31\u002b00:00","dateModified":"2018-02-09T03:42:31\u002b00:00","description":"At SmartAg, we use Docker to manage the development and runtime environments for our embedded software. For performing full-system…"}</script></head><body><div class=wrapper><nav class=navbar><div class=container><div class="navbar-header header-logo"><a href=https://www.thomasantony.com/>Thomas Antony</a></div><div class="menu navbar-right"><a class=menu-item href=https://www.thomasantony.com/ title>Home</a>
<a class=menu-item href=https://www.thomasantony.com/posts/ title>Blog</a>
<a class=menu-item href=https://www.thomasantony.com/publications/ title>Publications</a>
<a class=menu-item href=https://www.thomasantony.com/about/ title>About</a>
<a class=menu-item href=https://www.thomasantony.com/pdf/tantony-resume.pdf title>Resume</a>
<a href=javascript:void(0); class=theme-switch><i class="iconfont icon-sun"></i></a>&nbsp;</div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><div class=container><div class=navbar-header><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-sun"></i></a>&nbsp;<a href=https://www.thomasantony.com/>Thomas Antony</a></div><div class=menu-toggle><span></span><span></span><span></span></div></div><div class=menu id=mobile-menu><a class=menu-item href=https://www.thomasantony.com/ title>Home</a>
<a class=menu-item href=https://www.thomasantony.com/posts/ title>Blog</a>
<a class=menu-item href=https://www.thomasantony.com/publications/ title>Publications</a>
<a class=menu-item href=https://www.thomasantony.com/about/ title>About</a>
<a class=menu-item href=https://www.thomasantony.com/pdf/tantony-resume.pdf title>Resume</a></div></div></nav><main class=main><div class=container><article class=post-warp><header class=post-header><h1 class=post-title>Using VirtualCAN inside docker on macOS</h1><div class=post-meta>Written by <a href=https://www.thomasantony.com/ rel=author>Thomas Antony</a>
<span class=post-time>on <time datetime=2018-02-09>9 February 2018</time></span>
in
<i class="iconfont icon-folder"></i>
<span class=post-category><a href=https://www.thomasantony.com/categories/docker/>Docker</a></span>
<i class="iconfont icon-timer"></i>
3 min</div></header><div class=post-content><p>At <a href=http://www.smart-ag.com/>SmartAg</a>, we use Docker to manage the development and runtime environments for our embedded software. For performing full-system integrated tests, we have built comprehensive simulators that mimic the behavior of the hardware that we automate. Since most of the hardware communication happens over CAN, VirtualCAN is a great way of faking the hardware signals.</p><p><figure><img src=https://www.thomasantony.com/images/ring.svg data-sizes=auto data-src=https://www.thomasantony.com/images/medium/1__xk974__nijAtuCTMhs7B0__w.png alt class=lazyload><figcaption class=image-caption></figcaption></figure></p><p>Until now, any code that required a CAN interface could not run on my Macbook Pro. This was primarily because the linux kernel used by <a href=https://www.docker.com/docker-mac>Docker for Mac</a> lacks support for <a href=https://en.wikipedia.org/wiki/SocketCAN>SocketCAN</a> or VirtualCAN. After much <a href=https://github.com/docker/for-mac/issues/2580>head-bashing</a>, I realized that a better option would be <code>[docker-machine](https://docs.docker.com/machine/overview/)</code> , which is how docker was originally run on macOS before the official “Docker for Mac” release.</p><h3 id=setting-up-a-can-enabled-docker-machine-vm>Setting up a CAN-enabled docker-machine VM</h3><ol><li>Install <a href=https://brew.sh/>Homebrew</a> if you don’t already have it.</li><li>Install <code>docker</code>, <code>docker-machine</code> and some associated software</li></ol><p>brew install docker docker-compose docker-machine docker-credential-helper docker-machine-driver-xhyve</p><p>3. Clone the repo from <a href=https://github.com/boot2docker/boot2docker>https://github.com/boot2docker/boot2docker</a></p><p>4. Edit <code>kernel_config</code> in the <code>boot2docker</code> repo and add the following at the bottom:</p><pre><code>CONFIG\_CAN=y  
CONFIG\_CAN\_RAW=y  
CONFIG\_CAN\_VCAN=y  
CONFIG\_CAN\_DEV=y  
CAN\_SLCAN=y  
CAN\_BCM=y
</code></pre><p>5. Follow the instructions at <a href=https://github.com/boot2docker/boot2docker/blob/master/doc/BUILD.md>https://github.com/boot2docker/boot2docker/blob/master/doc/BUILD.md</a> to build your custom <code>boot2docker</code> image. This basically boils down to:</p><pre><code>docker build -t boot2docker .  
docker run --rm boot2docker &gt; boot2docker-can.iso
</code></pre><p>6. Fix some permissions required by the <code>xhyve</code> docker-machine driver.</p><pre><code>sudo chown root:wheel $(brew --prefix)/opt/docker-machine-driver-xhyve/bin/docker-machine-driver-xhyve  
sudo chmod u+s $(brew --prefix)/opt/docker-machine-driver-xhyve/bin/docker-machine-driver-xhyve
</code></pre><p>7. Create your new <code>docker-machine</code> VM with the following command. Change the command appropriately to allocate the desired number of CPUs, amount of RAM and disk space to the VM.</p><pre><code>docker-machine create default --driver xhyve --xhyve-experimental-nfs-share --xhyve-cpu-count=4 --xhyve-memory-size=4096 --xhyve-disk-size=40000 --xhyve-boot2docker-url boot2docker-can.iso
</code></pre><p>8. Your <code>docker-machine</code> VM is now ready. It should already be running. If you restart your machine, you can start the VM by typing <code>docker-machine start default</code> or stop it with <code>docker-machine stop default</code> .</p><p>9. Set the environment parameters to use docker with your new VM by running <code>eval $(docker-machine env default)</code> . This command has to be run every time you are in a new terminal. You can also add this to your <code>.bashrc</code> to make it automatic.</p><p>10. Check that it all works:</p><pre><code>docker run -it --rm --privileged alpine /bin/sh
</code></pre><p>Inside the docker container, run:</p><pre><code>zcat /proc/config.gz | grep CAN
</code></pre><p>The command should display the CAN flags that you set while compiling the kernel. SocketCAN/VirtualCAN is now enabled in any docker container that you start on this VM.</p><h3 id=caveats>Caveats</h3><p>Running <code>docker</code> using <code>docker-machine</code> means that some things, such as port-forwarding does not work as you expect. A handy script for exposing any ports you want from your VM to <code>localhost</code> can be found here: <a href=https://github.com/johanhaleby/docker-machine-port-forwarder>https://github.com/johanhaleby/docker-machine-port-forwarder</a></p></div><div class=post-copyright><p class=copyright-item><span>Share:</span>
<span><a href="//twitter.com/share?url=https%3a%2f%2fwww.thomasantony.com%2f2018%2fvirtual-can-docker-macos%2f&text=Using%20VirtualCAN%20inside%20docker%20on%20macOS&via=thomasantony" target=_blank title="Share on Twitter"><i class="iconfont icon-twitter"></i></a>
<a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.thomasantony.com%2f2018%2fvirtual-can-docker-macos%2f" target=_blank title="Share on Facebook"><i class="iconfont icon-facebook"></i></a>
<a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.thomasantony.com%2f2018%2fvirtual-can-docker-macos%2f&title=Using%20VirtualCAN%20inside%20docker%20on%20macOS" target=_blank title="Share on LinkedIn"><i class="iconfont icon-linkedin"></i></a></span></p></div><div class=post-tags><section><i class="iconfont icon-icon-tag"></i>Tag:
<span class=tag><a href=https://www.thomasantony.com/tags/docker/>#docker</a></span>
<span class=tag><a href=https://www.thomasantony.com/tags/socketcan/>#socketcan</a></span>
<span class=tag><a href=https://www.thomasantony.com/tags/canbus/>#CANbus</a></span>
<span class=tag><a href=https://www.thomasantony.com/tags/virtual-can/>#virtual-can</a></span></section><section><a href=javascript:window.history.back();>Back</a></span> ·
<span><a href=https://www.thomasantony.com/>Home</a></span></section></div><div class=post-nav><a href=https://www.thomasantony.com/2016/training-neural-net-for-sdc/ class=prev rel=prev title="Training a neural network in real-time to control a self-driving car"><i class="iconfont icon-dajiantou"></i>&nbsp;Training a neural network in real-time to control a self-driving car</a>
<a href=https://www.thomasantony.com/2019/2019-10-16-hello-world/ class=next rel=next title="Hello World!">Hello World!&nbsp;<i class="iconfont icon-xiaojiantou"></i></a></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span class=author itemprop=copyrightHolder><a href=https://www.thomasantony.com/>Thomas Antony</a> |</span>
<span>Crafted with ❤️&nbsp;&nbsp;by <a href=https://github.com/Fastbyte01/KeepIt target=_blank rel="external nofollow noopener noreffer">KeepIt</a> & <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a></span></div></footer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/lightgallery/1.7.2/css/lightgallery.min.css integrity="sha512-qPE3vKZNMU6bIOsds+KXztmNoUjlgPN+bvYKXNNg0TFac+Q81tUP/bM5e6qBqj0nXa6Tz6Vigxqzapd5d+xvOg==" crossorigin=anonymous><script src=https://www.thomasantony.com/js/vendor_gallery.min.js async></script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-56045487-1','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>